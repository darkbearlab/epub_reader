<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極簡 EPUB 閱讀器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    
    <style>
        :root { --bg-color: #ffffff; --nav-bg: #f8f9fa; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: var(--bg-color); }
        
        /* 頂部控制欄 */
        #controls { 
            padding: 10px; 
            background: var(--nav-bg); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
            justify-content: center;
        }

        #viewer { flex-grow: 1; width: 100%; max-width: 900px; margin: 0 auto; background: white; }

        /* 章節選單樣式 */
        #toc-select { max-width: 200px; padding: 5px; }

        /* 手機直式瀏覽優化 */
        @media (max-width: 600px) {
            #viewer { width: 100%; }
            #controls { padding: 5px; font-size: 14px; }
            #toc-select { max-width: 120px; }
        }
    </style>
</head>
<body>

<div id="controls">
    <input type="file" id="input" accept=".epub">
    <select id="toc-select"><option>請選擇檔案</option></select>
    <button id="prev">上一頁</button>
    <button id="next">下一頁</button>
</div>

<div id="viewer"></div>

<script>
    let book, rendition;
    const inputElement = document.getElementById("input");
    const tocSelect = document.getElementById("toc-select");

    inputElement.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = e => loadBook(e.target.result, file.name);
        reader.readAsArrayBuffer(file);
    });

    function loadBook(data, fileName) {
        if (book) book.destroy();
        
        book = ePub(data);
        
        // 設定渲染參數
        rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            flow: "paginated", // 翻頁模式
            manager: "default",
            allowScriptedContent: true
        });

        // 讀取進度
        const savedLocation = localStorage.getItem(`read_pos_${fileName}`);
        rendition.display(savedLocation || undefined);

        // 章節清單
        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option value="">目錄索引</option>';
            nav.toc.forEach(chapter => {
                const option = document.createElement("option");
                option.textContent = chapter.label.trim();
                option.value = chapter.href;
                tocSelect.appendChild(option);
            });
        });

        // 紀錄位置
        rendition.on("relocated", location => {
            localStorage.setItem(`read_pos_${fileName}`, location.start.cfi);
        });

        // 綁定翻頁
        document.getElementById("next").onclick = () => rendition.next();
        document.getElementById("prev").onclick = () => rendition.prev();
        tocSelect.onchange = (e) => e.target.value && rendition.display(e.target.value);

        // --- 互動支援 ---

        // 1. 鍵盤支援 (主視窗與 iframe 內)
        const keyListener = (e) => {
            if (e.key === "ArrowRight") rendition.next();
            if (e.key === "ArrowLeft") rendition.prev();
        };
        document.addEventListener("keyup", keyListener);
        rendition.on("keyup", keyListener);

        // 2. 觸控滑動支援 (使用 Hammer.js)
        // 由於 rendition 會在 iframe 內渲染，我們需要在 hook 中處理
        rendition.on("rendered", (section, view) => {
            const el = view.document.documentElement;
            const mc = new Hammer(el);
            
            mc.on("swipeleft", () => rendition.next());
            mc.on("swiperight", () => rendition.prev());
        });
    }
</script>

</body>
</html>
