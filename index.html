<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極簡 EPUB 閱讀器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    
    <style>
        :root { 
            --bg-color: #ffffff; 
            --nav-bg: #f8f9fa; 
            --text-color: #333333;
            --border-color: #ddd;
            --menu-shadow: rgba(0,0,0,0.1);
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --nav-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #444;
            --menu-shadow: rgba(0,0,0,0.5);
        }

        body { 
            font-family: sans-serif; 
            margin: 0; 
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            background: var(--bg-color); 
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }

        /* 右上角三點選單 */
        .menu-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        #menu-btn {
            background: var(--nav-bg);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }

        #dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 45px;
            background: var(--nav-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--menu-shadow);
            padding: 15px;
            min-width: 220px;
            flex-direction: column;
            gap: 12px;
        }

        #dropdown-menu.show { display: flex; }

        /* 閱讀器主體：確保不被底部按鈕蓋住 */
        #viewer { 
            flex: 1;
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto; 
            overflow: hidden;
        }

        /* 底部導覽區塊 */
        #bottom-nav {
            height: 60px;
            background: var(--nav-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 20px;
            z-index: 100;
        }

        .nav-btn {
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            height: 40px;
            width: 80px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-item { display: flex; flex-direction: column; gap: 5px; }
        button, select, input[type="file"] {
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="menu-container">
    <button id="menu-btn">⋮</button>
    <div id="dropdown-menu">
        <div class="menu-item">
            <label style="font-size: 12px;">開啟書籍</label>
            <input type="file" id="input" accept=".epub">
        </div>
        <div class="menu-item">
            <label style="font-size: 12px;">目錄索引</label>
            <select id="toc-select"><option>請先載入檔案</option></select>
        </div>
        <hr style="width:100%; border:0; border-top:1px solid var(--border-color); margin: 5px 0;">
        <button id="theme-toggle">切換模式</button>
    </div>
</div>

<div id="viewer"></div>

<div id="bottom-nav">
    <button class="nav-btn" id="prev">&lt;</button>
    <button class="nav-btn" id="next">&gt;</button>
</div>

<script>
    let book, rendition;
    const inputElement = document.getElementById("input");
    const tocSelect = document.getElementById("toc-select");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const menuBtn = document.getElementById("menu-btn");
    const dropdownMenu = document.getElementById("dropdown-menu");

    menuBtn.onclick = (e) => {
        dropdownMenu.classList.toggle('show');
        e.stopPropagation();
    };

    document.onclick = () => dropdownMenu.classList.remove('show');
    dropdownMenu.onclick = (e) => e.stopPropagation();

    const themes = {
        light: { 'body': { 'background': '#ffffff !important', 'color': '#333333 !important' } },
        dark: { 'body': { 'background': '#1a1a1a !important', 'color': '#e0e0e0 !important' } }
    };

    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
    }

    themeToggleBtn.onclick = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        if (rendition) rendition.themes.select(isDark ? "dark" : "light");
    };

    inputElement.onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => loadBook(e.target.result, file.name);
        reader.readAsArrayBuffer(file);
        dropdownMenu.classList.remove('show');
    };

    function loadBook(data, fileName) {
        if (book) book.destroy();
        book = ePub(data);
        rendition = book.renderTo("viewer", {
            width: "100%", height: "100%", flow: "paginated"
        });

        rendition.themes.register("light", themes.light);
        rendition.themes.register("dark", themes.dark);
        rendition.themes.select(document.body.classList.contains('dark-mode') ? "dark" : "light");

        const savedLocation = localStorage.getItem(`read_pos_${fileName}`);
        rendition.display(savedLocation || undefined);

        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option value="">跳至章節</option>';
            nav.toc.forEach(chapter => {
                const option = document.createElement("option");
                option.textContent = chapter.label.trim();
                option.value = chapter.href;
                tocSelect.appendChild(option);
            });
        });

        rendition.on("relocated", loc => localStorage.setItem(`read_pos_${fileName}`, loc.start.cfi));

        document.getElementById("next").onclick = () => rendition.next();
        document.getElementById("prev").onclick = () => rendition.prev();
        
        tocSelect.onchange = (e) => {
            if(e.target.value) {
                rendition.display(e.target.value);
                dropdownMenu.classList.remove('show');
            }
        };

        // 核心修正：正確監聽 iframe 內部的觸控滑動
        rendition.on("rendered", (section, view) => {
            const frameDoc = view.document.documentElement;
            const mc = new Hammer(frameDoc);
            
            // 允許垂直捲動穿透（如果需要），但捕捉水平滑動
            mc.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL });

            mc.on("swipeleft", () => {
                rendition.next();
            });
            mc.on("swiperight", () => {
                rendition.prev();
            });
        });

        // 鍵盤支援
        const keyListener = (e) => {
            if (e.key === "ArrowRight") rendition.next();
            if (e.key === "ArrowLeft") rendition.prev();
        };
        document.addEventListener("keyup", keyListener);
        rendition.on("keyup", keyListener);
    }
</script>

</body>
</html>
