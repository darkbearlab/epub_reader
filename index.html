<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極簡 EPUB 閱讀器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    
    <style>
        :root { 
            --bg-color: #ffffff; 
            --nav-bg: #f8f9fa; 
            --text-color: #333333;
            --border-color: #ddd;
        }

        /* 夜間模式變數 */
        body.dark-mode {
            --bg-color: #1a1a1a;
            --nav-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #444;
        }

        body { 
            font-family: sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            background: var(--bg-color); 
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }
        
        /* 頂部控制欄容器 */
        #top-bar {
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* 實際控制列 (支援收合動畫) */
        #controls-inner { 
            padding: 10px; 
            background: var(--nav-bg); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            justify-content: center;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            max-height: 300px; /* 設定一個足夠大的高度供展開動畫使用 */
            overflow: hidden;
            opacity: 1;
        }

        /* 收起時的狀態 */
        #controls-inner.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-bottom-color: transparent;
            opacity: 0;
        }

        /* 收合按鈕的懸浮容器 */
        #toggle-container {
            height: 0;
            display: flex;
            justify-content: center;
            position: relative;
            z-index: 11;
        }

        /* 收合按鈕外觀 */
        #toggle-btn {
            background: var(--nav-bg);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 2px 20px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-color);
            transform: translateY(-1px); /* 微調位置以蓋住原本的邊線 */
            transition: background 0.3s, color 0.3s;
        }

        /* 按鈕與選單基本樣式 */
        button, select, input[type="file"] {
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        #viewer { 
            flex-grow: 1; 
            width: 100%; 
            max-width: 900px; 
            margin: 0 auto; 
            background: transparent; 
        }

        /* 章節選單樣式 */
        #toc-select { max-width: 200px; }

        /* 手機直式瀏覽優化 */
        @media (max-width: 600px) {
            #viewer { width: 100%; }
            #controls-inner { padding: 5px; font-size: 14px; }
            #toc-select { max-width: 120px; }
        }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="controls-inner">
        <input type="file" id="input" accept=".epub">
        <select id="toc-select"><option>請選擇檔案</option></select>
        <button id="prev">上一頁</button>
        <button id="next">下一頁</button>
        <button id="theme-toggle">夜間模式</button>
    </div>
    <div id="toggle-container">
        <button id="toggle-btn">▲ 收起</button>
    </div>
</div>

<div id="viewer"></div>

<script>
    // --- 新增的收合面板邏輯 ---
    const toggleBtn = document.getElementById("toggle-btn");
    const controlsInner = document.getElementById("controls-inner");

    toggleBtn.addEventListener('click', () => {
        controlsInner.classList.toggle('collapsed');
        if (controlsInner.classList.contains('collapsed')) {
            toggleBtn.textContent = '▼ 展開';
        } else {
            toggleBtn.textContent = '▲ 收起';
        }
    });
    // --------------------------

    let book, rendition;
    const inputElement = document.getElementById("input");
    const tocSelect = document.getElementById("toc-select");
    const themeToggleBtn = document.getElementById("theme-toggle");

    // 定義書本內的日/夜間樣式
    const themes = {
        light: {
            body: { background: '#ffffff', color: '#333333' }
        },
        dark: {
            body: { background: '#1a1a1a', color: '#e0e0e0' }
        }
    };

    // 初始化主題狀態
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggleBtn.textContent = '日間模式';
    }

    // 切換主題按鈕邏輯
    themeToggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        
        // 記憶選擇
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        themeToggleBtn.textContent = isDark ? '日間模式' : '夜間模式';
        
        // 如果書本已經載入，即時切換書本內的主題
        if (rendition) {
            rendition.themes.select(isDark ? "dark" : "light");
        }
    });

    inputElement.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = e => loadBook(e.target.result, file.name);
        reader.readAsArrayBuffer(file);
    });

    function loadBook(data, fileName) {
        if (book) book.destroy();
        
        book = ePub(data);
        
        // 設定渲染參數
        rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            flow: "paginated", // 翻頁模式
            manager: "default",
            allowScriptedContent: true
        });

        // 註冊主題
        rendition.themes.register("light", themes.light);
        rendition.themes.register("dark", themes.dark);
        
        // 套用目前選擇的主題
        const isDark = document.body.classList.contains('dark-mode');
        rendition.themes.select(isDark ? "dark" : "light");

        // 讀取進度
        const savedLocation = localStorage.getItem(`read_pos_${fileName}`);
        rendition.display(savedLocation || undefined);

        // 章節清單
        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option value="">目錄索引</option>';
            nav.toc.forEach(chapter => {
                const option = document.createElement("option");
                option.textContent = chapter.label.trim();
                option.value = chapter.href;
                tocSelect.appendChild(option);
            });
        });

        // 紀錄位置
        rendition.on("relocated", location => {
            localStorage.setItem(`read_pos_${fileName}`, location.start.cfi);
        });

        // 綁定翻頁
        document.getElementById("next").onclick = () => rendition.next();
        document.getElementById("prev").onclick = () => rendition.prev();
        tocSelect.onchange = (e) => e.target.value && rendition.display(e.target.value);

        // --- 互動支援 ---

        // 1. 鍵盤支援 (主視窗與 iframe 內)
        const keyListener = (e) => {
            if (e.key === "ArrowRight") rendition.next();
            if (e.key === "ArrowLeft") rendition.prev();
        };
        document.addEventListener("keyup", keyListener);
        rendition.on("keyup", keyListener);

        // 2. 觸控滑動支援 (使用 Hammer.js)
        rendition.on("rendered", (section, view) => {
            const el = view.document.documentElement;
            const mc = new Hammer(el);
            
            mc.on("swipeleft", () => rendition.next());
            mc.on("swiperight", () => rendition.prev());
        });
    }
</script>

</body>
</html>
